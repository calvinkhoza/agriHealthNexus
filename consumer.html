<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriHealth Nexus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #27ae60;
            --accent: #e67e22;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --text: #333;
            --gray: #757575;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text);
        }

        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 20px;
            padding: 8px 15px;
            width: 300px;
        }
        
        .search-bar input {
            border: none;
            outline: none;
            flex-grow: 1;
            padding: 5px;
            color: var(--text);
        }
        
        .search-bar button {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
        }
        
        .nav-tabs {
            display: flex;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0 20px;
        }
        
        .nav-tab {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .nav-tab:hover {
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .nav-tab[data-tab="crop-analysis"] {
            cursor: pointer;
            font-weight: 600;
        }
        .nav-tab[data-tab="crop-analysis"]:hover {
            background-color: rgba(52, 152, 219, 0.08);
            color: var(--primary);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Marketplace Styles */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1606787366850-de6330128bfc?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            height: 300px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .hero h1 {
            font-size: 36px;
            margin-bottom: 15px;
        }
        
        .hero p {
            font-size: 18px;
            max-width: 600px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid white;
            color: white;
        }
        
        .btn-outline:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .categories {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .category-card {
            min-width: 120px;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .category-card img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .category-card.active {
            background-color: var(--light);
            border: 1px solid var(--primary);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .product-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .product-image {
            height: 180px;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .product-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--warning);
            color: var(--text);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .product-details {
            padding: 15px;
        }
        
        .product-farmer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .product-farmer img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .product-farmer span {
            font-size: 12px;
            color: var(--gray);
        }
        
        .product-title {
            font-weight: 500;
            margin-bottom: 5px;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
        }
        
        .product-price {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 15px;
        }
        
        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quantity-control button {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-control span {
            width: 30px;
            text-align: center;
        }
        
        .cart-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .cart-btn:hover {
            background-color: var(--secondary);
        }
        
        .farmers-section {
            margin-bottom: 40px;
        }
        
        .farmers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .farmer-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .farmer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .farmer-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 15px;
            border: 3px solid var(--light);
        }
        
        .farmer-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .farmer-location {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .farmer-rating {
            color: var(--warning);
            margin-bottom: 15px;
        }
        
        .view-farm-btn {
            background-color: var(--light);
            color: var(--primary);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Product Modal Styles */
        .product-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .product-modal-content {
            background-color: white;
            margin: 50px auto;
            max-width: 800px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .product-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .product-modal-body {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        @media (min-width: 768px) {
            .product-modal-body {
                flex-direction: row;
            }
        }
        
        .product-modal-image {
            flex: 1;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-modal-image img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        
        .product-modal-info {
            flex: 1;
            padding: 20px;
        }
        
        .product-modal-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .product-modal-farmer {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .product-modal-farmer img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .product-modal-price {
            font-size: 20px;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .product-modal-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .product-modal-specs {
            margin-bottom: 20px;
        }
        
        .product-modal-specs h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .product-modal-specs ul {
            list-style-type: none;
        }
        
        .product-modal-specs li {
            margin-bottom: 5px;
            display: flex;
        }
        
        .product-modal-specs li span:first-child {
            font-weight: 500;
            min-width: 120px;
            display: inline-block;
            color: var(--gray);
        }
        
        .product-modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .product-modal-actions .quantity-control {
            margin-right: 15px;
        }
        
        /* Farmer Modal Styles */
        .farmer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .farmer-modal-content {
            background-color: white;
            margin: 50px auto;
            max-width: 800px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .farmer-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .farmer-modal-body {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        @media (min-width: 768px) {
            .farmer-modal-body {
                flex-direction: row;
            }
        }
        
        .farmer-modal-image {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .farmer-modal-image img {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            border: 5px solid var(--light);
        }
        
        .farmer-modal-info {
            flex: 2;
            padding: 20px;
        }
        
        .farmer-modal-title {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .farmer-modal-location {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--gray);
        }
        
        .farmer-modal-rating {
            color: var(--warning);
            margin-bottom: 15px;
        }
        
        .farmer-modal-bio {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .farmer-modal-products {
            margin-bottom: 20px;
        }
        
        .farmer-modal-products h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .farmer-modal-products ul {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            list-style-type: none;
        }
        
        .farmer-modal-products li {
            background-color: var(--light);
            padding: 5px 10px;
            border-radius: 4px;
            color: var(--primary);
            font-size: 14px;
        }
        
        .farmer-modal-contact {
            margin-top: 20px;
        }
        
        .farmer-modal-contact h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .farmer-modal-contact p {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Checkout Modal Styles */
        .checkout-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .checkout-modal-content {
            background-color: white;
            margin: 50px auto;
            max-width: 600px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }
        
        .checkout-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }
        
        .checkout-modal-body {
            padding: 20px;
        }
        
        .checkout-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .checkout-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #eee;
            z-index: 1;
        }
        
        .checkout-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .checkout-step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--gray);
        }
        
        .checkout-step.active .checkout-step-number {
            background-color: var(--primary);
            color: white;
        }
        
        .checkout-step.completed .checkout-step-number {
            background-color: var(--secondary);
            color: white;
        }
        
        .checkout-step-label {
            font-size: 12px;
            color: var(--gray);
        }
        
        .checkout-step.active .checkout-step-label {
            color: var(--primary);
            font-weight: 500;
        }
        
        .checkout-step.completed .checkout-step-label {
            color: var(--secondary);
        }
        
        .checkout-form {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .checkout-summary {
            background-color: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .checkout-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .checkout-summary-total {
            font-weight: bold;
            font-size: 18px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .checkout-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .checkout-back-btn {
            background-color: #eee;
            color: var(--text);
        }
        
        .checkout-next-btn {
            background-color: var(--primary);
            color: white;
        }
        
        /* Payment Success Modal */
        .success-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .success-modal-content {
            background-color: white;
            margin: 50px auto;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .success-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .success-message {
            margin-bottom: 30px;
            color: var(--gray);
        }
        
        /* Crop Analysis Styles */
        .upload-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px dashed var(--primary);
            transition: all 0.3s ease;
            text-align: center;
        }

        .upload-box:hover {
            border-color: var(--secondary);
            transform: translateY(-5px);
        }

        #food-upload + label {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }

        #food-upload + label:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .ar-scanner-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s ease;
            margin-left: 15px;
            border: none;
            color: white;
            font-size: 1em;
            text-decoration: none;
            font-weight: 500;
        }

        .ar-scanner-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .detection-results {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-size: 1.2rem;
        }

        .nutrition-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .nutrition-item:last-child {
            border-bottom: none;
        }

        .map-container {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            margin-top: 30px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .vendor-popup h3 {
            margin: 0 0 10px;
            color: var(--primary);
        }

        .vendor-popup ul {
            padding-left: 20px;
            margin: 10px 0;
        }

        .directions-btn {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .directions-btn:hover {
            background: #2980b9;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .loading {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .nutrient-card {
            background: rgba(46, 204, 113, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .nutrient-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 5px 0;
        }

        .nutrient-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Cart Styles */
        .cart-icon {
            position: relative;
            cursor: pointer;
            color: white;
            font-size: 1.2rem;
        }
        
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .cart-sidebar.active {
            right: 0;
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .cart-items {
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .cart-item-details {
            flex-grow: 1;
        }
        
        .cart-item-title {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .cart-item-farmer {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .cart-item-price {
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .cart-item-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-item {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 12px;
            cursor: pointer;
        }
        
        .cart-summary {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .total {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: var(--secondary);
        }

        /* Mobile Styles */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
        }
        
        .mobile-search-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: white;
            cursor: pointer;
        }
        
        .mobile-search-bar {
            display: none;
            width: 100%;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .search-bar {
                display: none;
            }
            
            .mobile-search-btn {
                display: block;
            }
            
            .mobile-search-bar.active {
                display: flex;
            }
            
            .hero {
                height: 250px;
            }
            
            .hero h1 {
                font-size: 28px;
            }
            
            .hero p {
                font-size: 16px;
            }
            
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .categories {
                gap: 10px;
                padding-bottom: 5px;
            }
            
            .category-card {
                min-width: 100px;
                padding: 10px;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .product-image {
                height: 120px;
            }
            
            .farmers-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .upload-box {
                padding: 20px;
            }

            .map-container {
                height: 300px;
            }

            .button-group {
                flex-direction: column;
                align-items: center;
            }

            .ar-scanner-btn {
                margin-left: 0;
                margin-top: 15px;
            }
            
            .product-modal_body, .farmer-modal_body {
                flex-direction: column;
            }
            
            .product-modal-image, .farmer-modal-image {
                padding: 10px;
            }
            
            .product-modal-info, .farmer-modal-info {
                padding: 10px;
            }
            
            .product-modal-actions {
                flex-direction: column;
                gap: 10px;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">AgriHealth Nexus</div>
        <div class="header-actions">
            <div class="search-bar">
                <input type="text" placeholder="Search for fresh produce...">
                <button><i class="fas fa-search"></i></button>
            </div>
            <button class="mobile-search-btn" id="mobileSearchBtn">
                <i class="fas fa-search"></i>
            </button>
            <div class="cart-icon" id="cartIcon">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-count">0</span>
            </div>
            <div class="user-profile">
                <span>Sarah</span>
                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User Profile">
            </div>
        </div>
    </header>
    
    <div class="mobile-search-bar" id="mobileSearchBar">
        <input type="text" placeholder="Search for fresh produce..." class="form-control">
        <button class="btn btn-primary"><i class="fas fa-search"></i></button>
    </div>
    
    <div class="nav-tabs">
        <div class="nav-tab active" data-tab="marketplace">Marketplace</div>
        <div class="nav-tab" data-tab="crop-analysis">Crop Analysis</div>
        <div class="nav-tab" data-tab="gamification">Gamification</div>
        <div class="nav-tab" data-tab="farmers">Our Farmers</div>
    </div>
    
    <div class="container">
        <!-- Marketplace Tab -->
        <div class="tab-content active" id="marketplace">
            <div class="hero">
                <h1>Fresh Produce Direct From Local Farmers</h1>
                <p>Support South African farmers while enjoying the freshest, most nutritious food for your family</p>
                <div>
                    <button class="btn btn-primary" id="shopNowBtn">Shop Now</button>
                    <button class="btn btn-outline">Learn More</button>
                </div>
            </div>
            <div class="section-title">
                <span>Marketplace Highlights</span>
            </div>
            <div class="products-grid" id="highlightsGrid"></div>
            <div class="categories">
                <div class="category-card active" data-category="all">
                    <img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" alt="All">
                    <div>All Products</div>
                </div>
                <div class="category-card" data-category="vegetables">
                    <img src="https://cdn-icons-png.flaticon.com/512/2329/2329865.png" alt="Vegetables">
                    <div>Vegetables</div>
                </div>
                <div class="category-card" data-category="fruits">
                    <img src="https://cdn-icons-png.flaticon.com/512/415/415733.png" alt="Fruits">
                    <div>Fruits</div>
                </div>
                <div class="category-card" data-category="herbs">
                    <img src="https://cdn-icons-png.flaticon.com/512/2454/2454202.png" alt="Herbs">
                    <div>Herbs</div>
                </div>
                <div class="category-card" data-category="dairy">
                    <img src="https://cdn-icons-png.flaticon.com/512/3174/3174880.png" alt="Dairy">
                    <div>Dairy</div>
                </div>
                <div class="category-card" data-category="eggs">
                    <img src="https
            </div>
        </div>
        
        <!-- Crop Analysis Tab -->
        <div class="tab-content" id="crop-analysis">
            <div class="upload-box" id="drop-zone">
                <h2>Crop Health Analysis</h2>
                <p>Upload an image of your crop to analyze its health and get nutritional information</p>
                
                <div class="button-group">
                    <input type="file" id="food-upload" accept="image/*" hidden>
                    <label for="food-upload"> Upload Crop Image</label>
                    <button class="ar-scanner-btn" id="arScannerBtn">📲 AR Field Scanner</button>
                </div>
                
                <div class="loading" id="loading-indicator"></div>
                <img id="preview" class="preview-image" alt="Uploaded crop preview">
                
                <div class="detection-results" id="results">
                    <div class="nutrition-item">
                        <span>Crop Detected:</span>
                        <span id="detected-crop">-</span>
                    </div>
                    <div class="nutrition-item">
                        <span>Health Status:</span>
                        <span id="health-status">-</span>
                    </div>
                    <div class="nutrition-item">
                        <span>Nearest Vendor:</span>
                        <span id="nearest-vendor">-</span>
                    </div>
                    <div class="nutrition-item">
                        <span>Distance:</span>
                        <span id="vendor-distance">-</span>
                    </div>
                    
                    <div id="nutrition-data" class="nutrition-grid"></div>
                </div>
            </div>

            <div id="map" class="map-container"></div>
        </div>
        
        <!-- Gamification Tab -->
        <div class="tab-content" id="gamification">
            <div class="hero" style="background: linear-gradient(90deg, #6ee7b7 0%, #3b82f6 100%); color: white;">
                <h1>Play & Win!</h1>
                <p>Spin the wheel, answer quizzes, and climb the leaderboard to earn points and discounts!</p>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 30px; margin: 30px 0; justify-content: center;">
                <div style="background: white; border-radius: 15px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 30px; min-width: 300px; text-align: center;">
                    <h2>Spin the Wheel</h2>
                    <canvas id="spinWheel" width="220" height="220" style="margin: 20px 0;"></canvas>
                    <button class="btn btn-primary" id="spinBtn">Spin</button>
                    <div id="spinResult" style="margin-top: 15px; font-weight: bold;"></div>
                </div>
                <div style="background: white; border-radius: 15px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 30px; min-width: 300px; text-align: center;">
                    <h2>Your Points</h2>
                    <div id="userPoints" style="font-size: 2.5rem; color: var(--primary); margin: 20px 0;">0</div>
                    <h3>Leaderboard</h3>
                    <ol id="leaderboard" style="text-align: left; margin: 0 auto; max-width: 200px;"></ol>
                </div>
            </div>
        </div>
        
        <!-- Farmers Tab -->
        <div class="tab-content" id="farmers">
            <div class="hero" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80')">
                <h1>Meet Our Farming Community</h1>
                <p>Connect directly with local farmers committed to sustainable agriculture</p>
                <div>
                    <button class="btn btn-primary">Become a Partner</button>
                </div>
            </div>
            
            <div class="farmers-section">
                <div class="section-title">
                    <span>Featured Farmers</span>
                    <button class="btn btn-outline">View All</button>
                </div>
                
                <div class="farmers-grid" id="farmersTabGrid">
                    <!-- Farmers will be loaded here dynamically -->
                </div>
            </div>
            
            <div class="section-title">
                <span>Farmer Success Stories</span>
            </div>
            
            <div class="stories-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px;">
                <div class="story-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div class="story-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="https://randomuser.me/api/portraits/women/65.jpg" alt="Farmer" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <h3 style="margin: 0;">Nomsa Khumalo</h3>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: var(--gray);">Khayelitsha Urban Farm</p>
                        </div>
                    </div>
                    <p style="margin-bottom: 15px;">"AgriHealth Nexus helped me connect with customers directly, increasing my income by 40% while providing fresh produce to my community."</p>
                    <button class="btn btn-primary" style="width: 100%;">Read Full Story</button>
                </div>
                
                <div class="story-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div class="story-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Farmer" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <h3 style="margin: 0;">Thomas Mabaso</h3>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: var(--gray);">Soweto Urban Growers</p>
                        </div>
                    </div>
                    <p style="margin-bottom: 15px;">"The crop analysis tools helped me identify nutrient deficiencies early, saving my tomato crop from potential disaster."</p>
                    <button class="btn btn-primary" style="width: 100%;">Read Full Story</button>
                </div>
                
                <div class="story-card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <div class="story-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <img src="https://randomuser.me/api/portraits/men/75.jpg" alt="Farmer" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">
                        <div>
                            <h3 style="margin: 0;">Jacob van der Merwe</h3>
                            <p style="margin: 5px 0 0; font-size: 0.9rem; color: var(--gray);">Stellenbosch Roots</p>
                        </div>
                    </div>
                    <p style="margin-bottom: 15px;">"Through AgriHealth, I've been able to transition to organic farming while maintaining profitability and market access."</p>
                    <button class="btn btn-primary" style="width: 100%;">Read Full Story</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Modal -->
    <div class="product-modal" id="productModal">
        <div class="product-modal-content">
            <div class="product-modal-header">
                <h3 id="modalProductTitle">Product Details</h3>
                <button class="close-modal" id="closeProductModal">&times;</button>
            </div>
            <div class="product-modal-body">
                <div class="product-modal-image">
                    <img id="modalProductImage" src="" alt="Product Image">
                </div>
                <div class="product-modal-info">
                    <h3 class="product-modal-title" id="modalProductName">Product Name</h3>
                    <div class="product-modal-farmer">
                        <img id="modalFarmerImage" src="" alt="Farmer">
                        <span id="modalFarmerName">Farmer Name</span>
                    </div>
                    <div class="product-modal-price" id="modalProductPrice">R0.00</div>
                    <div class="product-modal-description" id="modalProductDescription">
                        Product description goes here with all the details about this amazing product.
                    </div>
                    <div class="product-modal-specs">
                        <h4>Product Specifications</h4>
                        <ul id="modalProductSpecs">
                            <!-- Specs will be added here dynamically -->
                        </ul>
                    </div>
                    <div class="product-modal-actions">
                        <div class="quantity-control">
                            <button id="modalDecreaseQty">-</button>
                            <span id="modalProductQty">1</span>
                            <button id="modalIncreaseQty">+</button>
                        </div>
                        <button class="btn btn-primary" id="modalAddToCart">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Farmer Modal -->
    <div class="farmer-modal" id="farmerModal">
        <div class="farmer-modal-content">
            <div class="farmer-modal-header">
                <h3 id="modalFarmerTitle">Farmer Profile</h3>
                <button class="close-modal" id="closeFarmerModal">&times;</button>
            </div>
            <div class="farmer-modal-body">
                <div class="farmer-modal-image">
                    <img id="modalFarmerProfileImage" src="" alt="Farmer">
                    <button class="btn btn-primary" id="viewFarmProducts">View Products</button>
                </div>
                <div class="farmer-modal-info">
                    <h3 class="farmer-modal-title" id="modalFarmerFullName">Farmer Name</h3>
                    <div class="farmer-modal-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="modalFarmerLocation">Location</span>
                    </div>
                    <div class="farmer-modal-rating" id="modalFarmerRating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                        <span>(24)</span>
                    </div>
                    <div class="farmer-modal-bio" id="modalFarmerBio">
                        Farmer bio goes here with information about their farming practices, history, and philosophy.
                    </div>
                    <div class="farmer-modal-products">
                        <h4>Specializes In</h4>
                        <ul id="modalFarmerProducts">
                            <!-- Products will be added here dynamically -->
                        </ul>
                    </div>
                    <div class="farmer-modal-contact">
                        <h4>Contact Information</h4>
                        <p><i class="fas fa-phone"></i> <span id="modalFarmerPhone">+27 12 345 6789</span></p>
                        <p><i class="fas fa-envelope"></i> <span id="modalFarmerEmail">farmer@example.com</span></p>
                        <p><i class="fas fa-globe"></i> <a href="#" id="modalFarmerWebsite" target="_blank">www.farmerwebsite.com</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3>Your Cart (<span id="cart-count">0</span>)</h3>
            <button class="close-cart" id="closeCart">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="cart-items" id="cart-items-container">
            <!-- Cart items will be added here dynamically -->
            <div style="text-align: center; padding: 20px; color: var(--gray);">
                Your cart is empty
            </div>
        </div>
        
        <div class="cart-summary" id="cart-summary" style="display: none;">
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="cart-subtotal">R0.00</span>
            </div>
            <div class="summary-row">
                <span>Delivery</span>
                <span id="cart-delivery">R25.00</span>
            </div>
            <div class="total">
                <span>Total</span>
                <span id="cart-total">R25.00</span>
            </div>
            <button class="checkout-btn" id="proceedToCheckout">Proceed to Checkout</button>
        </div>
    </div>
    
    <!-- Checkout Modal -->
    <div class="checkout-modal" id="checkoutModal">
        <div class="checkout-modal-content">
            <div class="checkout-modal-header">
                <h3>Checkout</h3>
                <button class="close-modal" id="closeCheckoutModal">&times;</button>
            </div>
            <div class="checkout-modal-body">
                <div class="checkout-steps">
                    <div class="checkout-step active" id="step1">
                        <div class="checkout-step-number">1</div>
                        <div class="checkout-step-label">Delivery</div>
                    </div>
                    <div class="checkout-step" id="step2">
                        <div class="checkout-step-number">2</div>
                        <div class="checkout-step-label">Payment</div>
                    </div>
                    <div class="checkout-step" id="step3">
                        <div class="checkout-step-number">3</div>
                        <div class="checkout-step-label">Confirmation</div>
                    </div>
                </div>
                
                <div class="checkout-form" id="deliveryForm">
                    <h4>Delivery Information</h4>
                    <div class="form-group">
                        <label for="deliveryName">Full Name</label>
                        <input type="text" id="deliveryName" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryAddress">Address</label>
                        <input type="text" id="deliveryAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryCity">City</label>
                        <input type="text" id="deliveryCity" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryPostalCode">Postal Code</label>
                        <input type="text" id="deliveryPostalCode" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryPhone">Phone Number</label>
                        <input type="tel" id="deliveryPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="deliveryNotes">Delivery Notes (Optional)</label>
                        <textarea id="deliveryNotes" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="checkout-form" id="paymentForm" style="display: none;">
                    <h4>Payment Information</h4>
                    <div class="form-group">
                        <label for="cardName">Name on Card</label>
                        <input type="text" id="cardName" required>
                    </div>
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" required>
                    </div>
                    <div class="form-group" style="display: flex; gap: 15px;">
                        <div style="flex: 1;">
                            <label for="cardExpiry">Expiry Date</label>
                            <input type="text" id="cardExpiry" placeholder="MM/YY" required>
                        </div>
                        <div style="flex: 1;">
                            <label for="cardCvv">CVV</label>
                            <input type="text" id="cardCvv" placeholder="123" required>
                        </div>
                    </div>
                    
                    <div class="checkout-summary">
                        <h4>Order Summary</h4>
                        <div class="checkout-summary-item">
                            <span>Subtotal</span>
                            <span id="checkout-subtotal">R0.00</span>
                        </div>
                        <div class="checkout-summary-item">
                            <span>Delivery</span>
                            <span id="checkout-delivery">R25.00</span>
                        </div>
                        <div class="checkout-summary-total">
                            <span>Total</span>
                            <span id="checkout-total">R25.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="checkout-form" id="confirmationForm" style="display: none; text-align: center;">
                    <h4>Confirm Your Order</h4>
                    <p>Please review your order details before completing your purchase.</p>
                    
                    <div class="checkout-summary">
                        <h4>Order Summary</h4>
                        <div class="checkout-summary-item">
                            <span>Subtotal</span>
                            <span id="confirm-subtotal">R0.00</span>
                        </div>
                        <div class="checkout-summary-item">
                            <span>Delivery</span>
                            <span id="confirm-delivery">R25.00</span>
                        </div>
                        <div class="checkout-summary-total">
                            <span>Total</span>
                            <span id="confirm-total">R25.00</span>
                        </div>
                    </div>
                    
                    <div style="text-align: left; margin-top: 20px;">
                        <h4>Delivery Information</h4>
                        <p id="confirm-delivery-info"></p>
                    </div>
                </div>
                
                <div class="checkout-actions">
                    <button class="btn checkout-back-btn" id="checkoutBackBtn" style="display: none;">Back</button>
                    <button class="btn checkout-next-btn" id="checkoutNextBtn">Next</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="success-title">Payment Successful!</h3>
            <p class="success-message">Thank you for your purchase. Your order has been placed successfully.</p>
            <button class="btn btn-primary" id="successCloseBtn">Continue Shopping</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Product Database
        const products = [
            {
                id: 1,
                name: 'Organic Cherry Tomatoes',
                farmer: 'Soweto Urban Growers',
                farmerId: 2,
                farmerImage: 'https://randomuser.me/api/portraits/men/32.jpg',
                price: 'R18.99/kg',
                image: 'https://images.unsplash.com/photo-1576045057995-568f588f82fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'vegetables',
                rating: 4.8,
                reviews: 24,
                distance: '15km away',
                description: 'Sweet and juicy organic cherry tomatoes grown using sustainable farming practices. Perfect for salads, snacks, or cooking.',
                specs: [
                    { label: 'Grade', value: 'Premium A' },
                    { label: 'Origin', value: 'Soweto, Johannesburg' },
                    { label: 'Harvest Date', value: '2 days ago' },
                    { label: 'Shelf Life', value: '7-10 days' },
                    { label: 'Certification', value: 'Organic Certified' }
                ]
            },
            {
                id: 2,
                name: 'Fresh Baby Spinach',
                farmer: 'Khayelitsha Greens',
                farmerId: 1,
                farmerImage: 'https://randomuser.me/api/portraits/women/65.jpg',
                price: 'R24.50/kg',
                image: 'https://images.unsplash.com/photo-1518977676601-b53f82aba655?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'vegetables',
                rating: 4.9,
                reviews: 36,
                distance: '8km away',
                description: 'Tender baby spinach leaves packed with nutrients. Grown hydroponically for maximum freshness and minimal environmental impact.',
                specs: [
                    { label: 'Grade', value: 'Premium A' },
                    { label: 'Origin', value: 'Khayelitsha, Cape Town' },
                    { label: 'Harvest Date', value: 'Today' },
                    { label: 'Shelf Life', value: '5-7 days' },
                    { label: 'Growing Method', value: 'Hydroponic' }
                ]
            },
            {
                id: 3,
                name: 'Sweet Baby Carrots',
                farmer: 'Stellenbosch Roots',
                farmerId: 3,
                farmerImage: 'https://randomuser.me/api/portraits/men/75.jpg',
                price: 'R21.99/kg',
                image: 'https://images.unsplash.com/photo-1589927986089-35812388d1f4?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'vegetables',
                rating: 4.7,
                reviews: 42,
                distance: '25km away',
                description: 'Crunchy and sweet baby carrots, perfect for snacking or cooking. Grown in rich, organic soil without harmful pesticides.',
                specs: [
                    { label: 'Grade', value: 'Class 1' },
                    { label: 'Origin', value: 'Stellenbosch' },
                    { label: 'Harvest Date', value: '3 days ago' },
                    { label: 'Shelf Life', value: '10-14 days' },
                    { label: 'Certification', value: 'Organic' }
                ]
            },
            {
                id: 4,
                name: 'Organic Sweet Potatoes',
                farmer: 'Paarl Valley Farms',
                farmerId: 4,
                farmerImage: 'https://randomuser.me/api/portraits/men/45.jpg',
                price: 'R15.75/kg',
                image: 'https://images.unsplash.com/photo-1601493700631-2b16ec4b4716?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'vegetables',
                rating: 4.6,
                reviews: 18,
                distance: '32km away',
                description: 'Rich and flavorful organic sweet potatoes. High in fiber and vitamins, perfect for roasting, mashing, or baking.',
                specs: [
                    { label: 'Grade', value: 'Class 1' },
                    { label: 'Origin', value: 'Paarl Valley' },
                    { label: 'Harvest Date', value: '1 week ago' },
                    { label: 'Shelf Life', value: '2-3 weeks' },
                    { label: 'Certification', value: 'Organic' }
                ]
            },
            {
                id: 5,
                name: 'Fresh Strawberries',
                farmer: 'Stellenbosch Roots',
                farmerId: 3,
                farmerImage: 'https://randomuser.me/api/portraits/men/75.jpg',
                price: 'R35.50/box',
                image: 'https://images.unsplash.com/photo-1464965911861-746a04b4bca6?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'fruits',
                rating: 4.8,
                reviews: 29,
                distance: '25km away',
                description: 'Juicy and sweet strawberries, hand-picked at peak ripeness. Each box contains approximately 500g of premium strawberries.',
                specs: [
                    { label: 'Grade', value: 'Premium' },
                    { label: 'Origin', value: 'Stellenbosch' },
                    { label: 'Harvest Date', value: 'Today' },
                    { label: 'Shelf Life', value: '3-5 days' },
                    { label: 'Weight', value: '500g per box' }
                ]
            },
            {
                id: 6,
                name: 'Organic Apples',
                farmer: 'Paarl Valley Farms',
                farmerId: 4,
                farmerImage: 'https://randomuser.me/api/portraits/men/45.jpg',
                price: 'R12.99/kg',
                image: 'https://images.unsplash.com/photo-1568702846914-96b305d2aaeb?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'fruits',
                rating: 4.5,
                reviews: 15,
                distance: '32km away',
                description: 'Crisp and flavorful organic apples. Grown using traditional methods without synthetic pesticides or fertilizers.',
                specs: [
                    { label: 'Grade', value: 'Class 1' },
                    { label: 'Variety', value: 'Royal Gala' },
                    { label: 'Origin', value: 'Paarl Valley' },
                    { label: 'Shelf Life', value: '2-3 weeks' },
                    { label: 'Certification', value: 'Organic' }
                ]
            },
            {
                id: 7,
                name: 'Fresh Basil',
                farmer: 'Khayelitsha Greens',
                farmerId: 1,
                farmerImage: 'https://randomuser.me/api/portraits/women/65.jpg',
                price: 'R18.50/bunch',
                image: 'https://images.unsplash.com/photo-1605210058421-1a0c0b6db53f?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'herbs',
                rating: 4.7,
                reviews: 22,
                distance: '8km away',
                description: 'Fragrant fresh basil with vibrant green leaves. Perfect for pesto, salads, or as a garnish.',
                specs: [
                    { label: 'Grade', value: 'Premium' },
                    { label: 'Origin', value: 'Khayelitsha, Cape Town' },
                    { label: 'Harvest Date', value: 'Today' },
                    { label: 'Shelf Life', value: '3-5 days' },
                    { label: 'Growing Method', value: 'Hydroponic' }
                ]
            },
            {
                id: 8,
                name: 'Free Range Eggs',
                farmer: 'Soweto Urban Growers',
                farmerId: 2,
                farmerImage: 'https://randomuser.me/api/portraits/men/32.jpg',
                price: 'R45.00/dozen',
                image: 'https://images.unsplash.com/photo-1587486913049-53fc88980cfc?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80',
                category: 'eggs',
                rating: 4.9,
                reviews: 38,
                distance: '15km away',
                description: 'Free range eggs from happy, healthy chickens. Rich in flavor and nutrients with vibrant orange yolks.',
                specs: [
                    { label: 'Grade', value: 'Large' },
                    { label: 'Origin', value: 'Soweto, Johannesburg' },
                    { label: 'Collection Date', value: 'Today' },
                    { label: 'Shelf Life', value: '3 weeks' },
                    { label: 'Certification', value: 'Free Range' }
                ]
            }
        ];

        // Farmers Database
        const farmers = [
            {
                id: 1,
                name: 'Nomsa Khumalo',
                farm: 'Khayelitsha Greens',
                location: 'Khayelitsha, Cape Town',
                rating: 4.9,
                reviews: 36,
                image: 'https://randomuser.me/api/portraits/women/65.jpg',
                bio: 'Nomsa started Khayelitsha Greens in 2015 with a small hydroponic setup in her backyard. Today, she operates a thriving urban farm providing fresh produce to her community while creating jobs for local women.',
                products: ['Spinach', 'Kale', 'Lettuce', 'Basil', 'Coriander'],
                contact: {
                    phone: '+27 21 123 4567',
                    email: 'nomsa@khayelitshagreens.co.za',
                    website: 'www.khayelitshagreens.co.za'
                }
            },
            {
                id: 2,
                name: 'Thomas Mabaso',
                farm: 'Soweto Urban Growers',
                location: 'Soweto, Johannesburg',
                rating: 4.8,
                reviews: 24,
                image: 'https://randomuser.me/api/portraits/men/32.jpg',
                bio: 'Thomas transformed an abandoned lot in Soweto into a productive urban farm. Specializing in tomatoes and eggs, his farm is a model for sustainable urban agriculture in South Africa.',
                products: ['Tomatoes', 'Eggs', 'Peppers', 'Eggplant'],
                contact: {
                    phone: '+27 11 234 5678',
                    email: 'thomas@sowetourbangrowers.co.za',
                    website: 'www.sowetourbangrowers.co.za'
                }
            },
            {
                id: 3,
                name: 'Jacob van der Merwe',
                farm: 'Stellenbosch Roots',
                location: 'Stellenbosch',
                rating: 4.7,
                reviews: 42,
                image: 'https://randomuser.me/api/portraits/men/75.jpg',
                bio: 'A third-generation farmer, Jacob transitioned the family farm to organic practices in 2010. His farm produces a variety of vegetables and fruits using regenerative agriculture techniques.',
                products: ['Carrots', 'Potatoes', 'Onions', 'Strawberries'],
                contact: {
                    phone: '+27 21 345 6789',
                    email: 'jacob@stellenboschroots.co.za',
                    website: 'www.stellenboschroots.co.za'
                }
            },
            {
                id: 4,
                name: 'Pieter Botha',
                farm: 'Paarl Valley Farms',
                location: 'Paarl Valley',
                rating: 4.6,
                reviews: 18,
                image: 'https://randomuser.me/api/portraits/men/45.jpg',
                bio: 'Pieter manages a diverse farm in the fertile Paarl Valley. With a focus on soil health and biodiversity, his farm produces high-quality vegetables and fruits year-round.',
                products: ['Sweet Potatoes', 'Apples', 'Pears', 'Citrus'],
                contact: {
                    phone: '+27 21 456 7890',
                    email: 'pieter@paarlvalleyfarms.co.za',
                    website: 'www.paarlvalleyfarms.co.za'
                }
            }
        ];

        // Nutrition database for crops
        const nutritionDatabase = {
            maize: { calories: 365, carbs: 74, protein: 9, fat: 4, fiber: 7, vitamins: "B1, B3, B9" },
            wheat: { calories: 340, carbs: 72, protein: 13, fat: 2, fiber: 11, vitamins: "B1, B3, B6" },
            grapes: { calories: 69, carbs: 18, protein: 1, fat: 0, fiber: 1, vitamins: "C, K" },
            citrus: { calories: 43, carbs: 11, protein: 1, fat: 0, fiber: 2, vitamins: "C, B6" },
            sunflower: { calories: 584, carbs: 20, protein: 21, fat: 51, fiber: 9, vitamins: "E, B1" },
            potatoes: { calories: 77, carbs: 17, protein: 2, fat: 0, fiber: 2, vitamins: "C, B6" },
            tomatoes: { calories: 18, carbs: 4, protein: 1, fat: 0, fiber: 1, vitamins: "C, K" },
            bananas: { calories: 89, carbs: 23, protein: 1, fat: 0, fiber: 3, vitamins: "C, B6" },
            apples: { calories: 52, carbs: 14, protein: 0, fat: 0, fiber: 2, vitamins: "C, K" },
            spinach: { calories: 23, carbs: 3.6, protein: 2.9, fat: 0.4, fiber: 2.2, vitamins: "A, C, K" },
            carrots: { calories: 41, carbs: 9.6, protein: 0.9, fat: 0.2, fiber: 2.8, vitamins: "A, K" }
        };

        // Provincial boundaries and products data
        const provinceBounds = {
            gauteng: { lat: [-26.5, -25.0], lng: [27.0, 29.0] },
            westernCape: { lat: [-35.0, -31.0], lng: [17.0, 23.0] },
            easternCape: { lat: [-34.0, -30.5], lng: [22.0, 30.0] },
            kwazuluNatal: { lat: [-31.0, -27.0], lng: [29.0, 32.5] },
            limpopo: { lat: [-25.0, -22.0], lng: [27.0, 31.5] },
            mpumalanga: { lat: [-27.0, -24.5], lng: [29.0, 31.5] },
            northWest: { lat: [-27.5, -24.5], lng: [23.0, 27.0] },
            freeState: { lat: [-30.5, -27.0], lng: [25.0, 29.0] },
            northernCape: { lat: [-33.0, -25.0], lng: [17.0, 24.0] }
        };
        const provinceProducts = {
            gauteng: ["Tomatoes", "Spinach", "Eggs", "Peppers"],
            westernCape: ["Grapes", "Citrus", "Apples", "Pears"],
            easternCape: ["Dairy", "Wool", "Maize", "Beef"],
            kwazuluNatal: ["Sugar Cane", "Bananas", "Tea", "Avocados"],
            limpopo: ["Mangoes", "Macadamia Nuts", "Tomatoes", "Citrus"],
            mpumalanga: ["Maize", "Sugar", "Citrus", "Beef"],
            northWest: ["Sunflower", "Maize", "Beef", "Poultry"],
            freeState: ["Maize", "Wheat", "Beans", "Potatoes"],
            northernCape: ["Grapes", "Dates", "Olives", "Sheep"]
        };

        // DOM Elements
        const productsGrid = document.getElementById('productsGrid');
        const farmersGrid = document.getElementById('farmersGrid');
        const farmersTabGrid = document.getElementById('farmersTabGrid');
        const productModal = document.getElementById('productModal');
        const farmerModal = document.getElementById('farmerModal');
        const cartSidebar = document.getElementById('cartSidebar');
        const cartIcon = document.getElementById('cartIcon');
        const closeCart = document.getElementById('closeCart');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartSummary = document.getElementById('cart-summary');
        const cartCount = document.querySelector('.cart-count');
        const checkoutModal = document.getElementById('checkoutModal');
        const closeCheckoutModal = document.getElementById('closeCheckoutModal');
        const successModal = document.getElementById('successModal');
        const successCloseBtn = document.getElementById('successCloseBtn');
        const mobileSearchBtn = document.getElementById('mobileSearchBtn');
        const mobileSearchBar = document.getElementById('mobileSearchBar');
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const categoryCards = document.querySelectorAll('.category-card');
        const dropZone = document.getElementById('drop-zone');
        const foodUpload = document.getElementById('food-upload');
        const preview = document.getElementById('preview');
        const loadingIndicator = document.getElementById('loading-indicator');
        const results = document.getElementById('results');
        const detectedCrop = document.getElementById('detected-crop');
        const healthStatus = document.getElementById('health-status');
        const nearestVendor = document.getElementById('nearest-vendor');
        const vendorDistance = document.getElementById('vendor-distance');
        const nutritionData = document.getElementById('nutrition-data');
        const mapElement = document.getElementById('map');
        const arScannerBtn = document.getElementById('arScannerBtn');

        // Cart state
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentTab = 'marketplace';
        let currentStep = 1;

        // Initialize the application
        function init() {
            renderProducts();
            renderFarmers();
            setupEventListeners();
            updateCartCount();

            // Initialize map if on crop analysis tab
            if (window.location.hash === '#crop-analysis') {
                switchTab('crop-analysis');
                initMap();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation tabs
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Category filters
            categoryCards.forEach(card => {
                card.addEventListener('click', () => filterProducts(card.dataset.category));
            });

            // Product modal
            document.getElementById('closeProductModal').addEventListener('click', () => {
                productModal.style.display = 'none';
            });

            // Farmer modal
            document.getElementById('closeFarmerModal').addEventListener('click', () => {
                farmerModal.style.display = 'none';
            });

            // Cart interactions
            cartIcon.addEventListener('click', toggleCart);
            closeCart.addEventListener('click', toggleCart);
            document.getElementById('proceedToCheckout').addEventListener('click', openCheckoutModal);

            // Checkout modal
            closeCheckoutModal.addEventListener('click', () => {
                checkoutModal.style.display = 'none';
            });
            document.getElementById('checkoutNextBtn').addEventListener('click', nextStep);
            document.getElementById('checkoutBackBtn').addEventListener('click', prevStep);
            successCloseBtn.addEventListener('click', () => {
                successModal.style.display = 'none';
            });

            // Mobile search
            mobileSearchBtn.addEventListener('click', () => {
                mobileSearchBar.classList.toggle('active');
            });

            // File upload for crop analysis
            foodUpload.addEventListener('change', handleFileUpload);

            // Drag and drop for crop analysis
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });

            dropZone.addEventListener('drop', handleDrop, false);

            // AR Scanner button
            arScannerBtn.addEventListener('click', () => {
                window.location.href = 'ARscanner.html';
            });
        }

        // Prevent default drag and drop behavior
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop zone
        function highlight() {
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.backgroundColor = 'rgba(46, 204, 113, 0.1)';
        }

        // Unhighlight drop zone
        function unhighlight() {
            dropZone.style.borderColor = 'var(--primary)';
            dropZone.style.backgroundColor = 'white';
        }

        // Handle dropped files
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // Handle file upload
        function handleFileUpload(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        // Process uploaded files
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        analyzeImage(e.target.result);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        // Simulate image analysis
        function analyzeImage(imageSrc) {
            loadingIndicator.style.display = 'block';
            results.style.opacity = '0.5';

            // Simulate API call with timeout
            setTimeout(() => {
                // This is where you would normally call your ML API
                // For demo purposes, we're using mock data
                const mockCrops = ['maize', 'wheat', 'grapes', 'citrus', 'sunflower', 'potatoes', 
                                 'tomatoes', 'bananas', 'apples', 'spinach', 'carrots'];
                const randomCrop = mockCrops[Math.floor(Math.random() * mockCrops.length)];
                const healthStatuses = ['Healthy', 'Mild Stress', 'Nutrient Deficiency', 'Pest Damage'];
                const randomHealth = healthStatuses[Math.floor(Math.random() * healthStatuses.length)];
                
                detectedCrop.textContent = randomCrop.charAt(0).toUpperCase() + randomCrop.slice(1);
                healthStatus.textContent = randomHealth;
                
                // Set color based on health status
                if (randomHealth === 'Healthy') {
                    healthStatus.style.color = 'var(--primary)';
                } else if (randomHealth === 'Mild Stress') {
                    healthStatus.style.color = 'var(--warning)';
                } else {
                    healthStatus.style.color = 'var(--danger)';
                }
                
                // Display nutrition data
                displayNutritionData(randomCrop);
                
                // Find nearest vendor (mock)
                const vendors = [
                    { name: "Khayelitsha Greens", distance: "8km", location: [-33.933, 18.633] },
                    { name: "Soweto Urban Growers", distance: "15km", location: [-26.267, 27.858] },
                    { name: "Stellenbosch Roots", distance: "25km", location: [-33.932, 18.860] },
                    { name: "Paarl Valley Farms", distance: "32km", location: [-33.733, 18.967] }
                ];
                
                const randomVendor = vendors[Math.floor(Math.random() * vendors.length)];
                nearestVendor.textContent = randomVendor.name;
                vendorDistance.textContent = randomVendor.distance;
                
                // Update map with vendor location
                updateMap(randomVendor.location);
                
                loadingIndicator.style.display = 'none';
                results.style.opacity = '1';
            }, 1500);
        }

        // Display nutrition data
        function displayNutritionData(crop) {
            const nutrition = nutritionDatabase[crop] || nutritionDatabase['maize'];
            nutritionData.innerHTML = '';

            if (nutrition) {
                const nutrients = [
                    { label: 'Calories', value: nutrition.calories, unit: 'kcal' },
                    { label: 'Carbs', value: nutrition.carbs, unit: 'g' },
                    { label: 'Protein', value: nutrition.protein, unit: 'g' },
                    { label: 'Fat', value: nutrition.fat, unit: 'g' },
                    { label: 'Fiber', value: nutrition.fiber, unit: 'g' },
                    { label: 'Vitamins', value: nutrition.vitamins, unit: '' }
                ];
                
                nutrients.forEach(nutrient => {
                    const card = document.createElement('div');
                    card.className = 'nutrient-card';
                    card.innerHTML = `
                        <div class="nutrient-value">${nutrient.value}${nutrient.unit ? `<span class="nutrient-unit">${nutrient.unit}</span>` : ''}</div>
                        <div class="nutrient-label">${nutrient.label}</div>
                    `;
                    nutritionData.appendChild(card);
                });
            }
        }

        // Initialize map
        function initMap() {
            if (!window.map) {
                window.map = L.map('map').setView([-28.4796, 24.698], 5);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.map);
                
                // Add provincial boundaries (simplified for demo)
                Object.entries(provinceBounds).forEach(([province, bounds]) => {
                    const polygon = L.polygon([
                        [bounds.lat[0], bounds.lng[0]],
                        [bounds.lat[0], bounds.lng[1]],
                        [bounds.lat[1], bounds.lng[1]],
                        [bounds.lat[1], bounds.lng[0]]
                    ], {
                        color: 'var(--primary)',
                        fillOpacity: 0.1,
                        weight: 1
                    }).addTo(window.map);
                    
                    // Add popup with products
                    const products = provinceProducts[province] || [];
                    polygon.bindPopup(`
                        <div class="vendor-popup">
                            <h3>${province.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</h3>
                            <p>Main agricultural products:</p>
                            <ul>
                                ${products.map(p => `<li>${p}</li>`).join('')}
                            </ul>
                        </div>
                    `);
                });
            }
        }

        // Update map with vendor location
        function updateMap(location) {
            if (!window.map) initMap();

            // Clear existing markers
            if (window.vendorMarker) {
                window.map.removeLayer(window.vendorMarker);
            }

            // Add new marker
            window.vendorMarker = L.marker(location).addTo(window.map)
                .bindPopup(`
                    <div class="vendor-popup">
                        <h3>${nearestVendor.textContent}</h3>
                        <p>${vendorDistance.textContent} away</p>
                        <a href="#" class="directions-btn">Get Directions</a>
                    </div>
                `)
                .openPopup();

            // Center map on marker
            window.map.setView(location, 10);
        }

        // Switch between tabs
        function switchTab(tabId) {
            // If crop-analysis tab is clicked, redirect to ARscanner.html
            if (tabId === 'crop-analysis') {
                window.location.href = 'ARscanner.html';
                return;
            }
            // If gamification tab is clicked, redirect to gamification.html
            if (tabId === 'gamification') {
                window.location.href = 'gamification.html';
                return;
            }
            
            currentTab = tabId;
            navTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === tabId);
                if (content.id === tabId) {
                    if (tabId === 'marketplace') {
                        renderProducts();
                    }
                }
            });
            window.location.hash = tabId;
        }

        // Filter products by category
        function filterProducts(category) {
            // Update active category styling
            categoryCards.forEach(card => {
                if (card.dataset.category === category) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            // Filter and render products
            renderProducts(category);
        }

        // Render products to the grid
        function renderProducts(category = 'all') {
            productsGrid.innerHTML = '';

            const filteredProducts = category === 'all' 
                ? products 
                : products.filter(p => p.category === category);

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image}" alt="${product.name}">
                        ${product.rating >= 4.8 ? '<span class="product-badge">Popular</span>' : ''}
                    </div>
                    <div class="product-details">
                        <div class="product-farmer">
                            <img src="${product.farmerImage}" alt="${product.farmer}">
                            <span>${product.farmer}</span>
                        </div>
                        <h3 class="product-title">${product.name}</h3>
                        <div class="product-price">${product.price}</div>
                        <div class="product-meta">
                            <span><i class="fas fa-star" style="color: var(--warning);"></i> ${product.rating} (${product.reviews})</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${product.distance}</span>
                        </div>
                        <div class="product-actions">
                            <div class="quantity-control">
                                <button class="decrease-qty">-</button>
                                <span class="product-qty">1</span>
                                <button class="increase-qty">+</button>
                            </div>
                            <button class="cart-btn">Add to Cart</button>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                productCard.querySelector('.product-image').addEventListener('click', () => openProductModal(product));
                productCard.querySelector('.product-farmer').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openFarmerModal(product.farmerId);
                });
                productCard.querySelector('.cart-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    addToCart(product, parseInt(productCard.querySelector('.product-qty').textContent));
                });
                
                productsGrid.appendChild(productCard);
            });
        }

        // Render farmers to the grid
        function renderFarmers() {
            farmersGrid.innerHTML = '';
            farmersTabGrid.innerHTML = '';

            farmers.forEach(farmer => {
                const farmerCard = document.createElement('div');
                farmerCard.className = 'farmer-card';
                farmerCard.innerHTML = `
                    <img src="${farmer.image}" alt="${farmer.name}" class="farmer-avatar">
                    <h3 class="farmer-name">${farmer.name}</h3>
                    <div class="farmer-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${farmer.location}</span>
                    </div>
                    <div class="farmer-rating">
                        ${renderStars(farmer.rating)} (${farmer.reviews})
                    </div>
                    <button class="view-farm-btn">View Farm</button>
                `;
                
                farmerCard.addEventListener('click', () => openFarmerModal(farmer.id));
                
                farmersGrid.appendChild(farmerCard.cloneNode(true));
                farmersTabGrid.appendChild(farmerCard);
            });
        }

        // Render star ratings
        function renderStars(rating) {
            let stars = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;

            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }

            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }

            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }

            return stars;
        }

        // Open product modal
        function openProductModal(product) {
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductImage').src = product.image;
            document.getElementById('modalFarmerName').textContent = product.farmer;
            document.getElementById('modalFarmerImage').src = product.farmerImage;
            document.getElementById('modalProductPrice').textContent = product.price;
            document.getElementById('modalProductDescription').textContent = product.description;

            const specsList = document.getElementById('modalProductSpecs');
            specsList.innerHTML = '';

            product.specs.forEach(spec => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${spec.label}:</span> <span>${spec.value}</span>`;
                specsList.appendChild(li);
            });

            // Reset quantity
            document.getElementById('modalProductQty').textContent = '1';

            // Update add to cart button
            const addToCartBtn = document.getElementById('modalAddToCart');
            addToCartBtn.textContent = 'Add to Cart';
            addToCartBtn.onclick = () => {
                const quantity = parseInt(document.getElementById('modalProductQty').textContent);
                addToCart(product, quantity);
                addToCartBtn.textContent = 'Added!';
                setTimeout(() => {
                    addToCartBtn.textContent = 'Add to Cart';
                }, 2000);
            };

            // Quantity controls
            document.getElementById('modalDecreaseQty').onclick = () => {
                const qtyElement = document.getElementById('modalProductQty');
                let qty = parseInt(qtyElement.textContent);
                if (qty > 1) {
                    qtyElement.textContent = qty - 1;
                }
            };

            document.getElementById('modalIncreaseQty').onclick = () => {
                const qtyElement = document.getElementById('modalProductQty');
                let qty = parseInt(qtyElement.textContent);
                qtyElement.textContent = qty + 1;
            };

            // View farmer button
            document.querySelector('.product-modal-farmer').onclick = (e) => {
                e.stopPropagation();
                productModal.style.display = 'none';
                openFarmerModal(product.farmerId);
            };

            productModal.style.display = 'block';
        }

        // Open farmer modal
        function openFarmerModal(farmerId) {
            const farmer = farmers.find(f => f.id === farmerId);
            if (!farmer) return;

            document.getElementById('modalFarmerFullName').textContent = farmer.name;
            document.getElementById('modalFarmerProfileImage').src = farmer.image;
            document.getElementById('modalFarmerLocation').textContent = farmer.location;
            document.getElementById('modalFarmerRating').innerHTML = renderStars(farmer.rating) + ` <span>(${farmer.reviews})</span>`;
            document.getElementById('modalFarmerBio').textContent = farmer.bio;

            const productsList = document.getElementById('modalFarmerProducts');
            productsList.innerHTML = '';

            farmer.products.forEach(product => {
                const li = document.createElement('li');
                li.textContent = product;
                productsList.appendChild(li);
            });

            document.getElementById('modalFarmerPhone').textContent = farmer.contact.phone;
            document.getElementById('modalFarmerEmail').textContent = farmer.contact.email;
            document.getElementById('modalFarmerWebsite').textContent = farmer.contact.website;
            document.getElementById('modalFarmerWebsite').href = farmer.contact.website;

            // View products button
            document.getElementById('viewFarmProducts').onclick = () => {
                farmerModal.style.display = 'none';
                switchTab('marketplace');
                filterProducts('all');
                // Scroll to products section
                setTimeout(() => {
                    document.querySelector('.products-grid').scrollIntoView({ behavior: 'smooth' });
                }, 100);
            };

            farmerModal.style.display = 'block';
        }

        // Add item to cart
        function addToCart(product, quantity = 1) {
            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: parseFloat(product.price.replace(/[^0-9.]/g, '')),
                    image: product.image,
                    farmer: product.farmer,
                    quantity: quantity
                });
            }

            updateCart();
            showCartNotification(`${quantity} ${product.name} added to cart`);
        }

        // Update cart UI
        function updateCart() {
            // Save to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));

            // Update cart count
            updateCartCount();

            // Update cart items
            renderCartItems();
        }

        // Update cart count in header
        function updateCartCount() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
            document.getElementById('cart-count').textContent = totalItems;
        }

        // Render cart items
        function renderCartItems() {
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray);">Your cart is empty</div>';
                cartSummary.style.display = 'none';
                return;
            }

            cartSummary.style.display = 'block';

            let subtotal = 0;

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h4 class="cart-item-title">${item.name}</h4>
                        <div class="cart-item-farmer">${item.farmer}</div>
                        <div class="cart-item-price">R${item.price.toFixed(2)}</div>
                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button class="decrease-qty">-</button>
                                <span class="product-qty">${item.quantity}</span>
                                <button class="increase-qty">+</button>
                            </div>
                            <button class="remove-item">Remove</button>
                        </div>
                    </div>
                `;
                
                // Quantity controls
                cartItem.querySelector('.decrease-qty').addEventListener('click', () => {
                    if (item.quantity > 1) {
                        item.quantity--;
                        updateCart();
                    } else {
                        removeFromCart(item.id);
                    }
                });
                
                cartItem.querySelector('.increase-qty').addEventListener('click', () => {
                    item.quantity++;
                    updateCart();
                });
                
                // Remove button
                cartItem.querySelector('.remove-item').addEventListener('click', () => {
                    removeFromCart(item.id);
                });
                
                cartItemsContainer.appendChild(cartItem);
            });

            // Update summary
            const deliveryFee = 25.00;
            const total = subtotal + deliveryFee;

            document.getElementById('cart-subtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `R${total.toFixed(2)}`;

            // Also update checkout modal summaries
            document.getElementById('checkout-subtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('checkout-total').textContent = `R${total.toFixed(2)}`;
            document.getElementById('confirm-subtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('confirm-total').textContent = `R${total.toFixed(2)}`;
        }

        // Remove item from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }

        // Toggle cart sidebar
        function toggleCart() {
            cartSidebar.classList.toggle('active');

            if (cartSidebar.classList.contains('active')) {
                renderCartItems();
            }
        }

        // Show cart notification
        function showCartNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'cart-notification';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = 'var(--primary)';
            notification.style.color = 'white';
            notification.style.padding = '15px 25px';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 3px 10px rgba(0,0,0,0.2)';
            notification.style.zIndex = '1000';
            notification.style.animation = 'fadeIn 0.3s forwards';

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Open checkout modal
        function openCheckoutModal() {
            checkoutModal.style.display = 'block';
            currentStep = 1;
            updateCheckoutSteps();
            cartSidebar.classList.remove('active');
        }

        // Update checkout steps UI
        function updateCheckoutSteps() {
            // Update step indicators
            document.getElementById('step1').className = `checkout-step ${currentStep === 1 ? 'active' : currentStep > 1 ? 'completed' : ''}`;
            document.getElementById('step2').className = `checkout-step ${currentStep === 2 ? 'active' : currentStep > 2 ? 'completed' : ''}`;
            document.getElementById('step3').className = `checkout-step ${currentStep === 3 ? 'active' : ''}`;

            // Show/hide forms
            document.getElementById('deliveryForm').style.display = currentStep === 1 ? 'block' : 'none';
            document.getElementById('paymentForm').style.display = currentStep === 2 ? 'block' : 'none';
            document.getElementById('confirmationForm').style.display = currentStep === 3 ? 'block' : 'none';

            // Update button text
            const nextBtn = document.getElementById('checkoutNextBtn');
            nextBtn.textContent = currentStep === 3 ? 'Complete Order' : 'Next';

            // Show/hide back button
            document.getElementById('checkoutBackBtn').style.display = currentStep > 1 ? 'block' : 'none';

            // Update confirmation details if on step 3
            if (currentStep === 3) {
                const name = document.getElementById('deliveryName').value;
                const address = document.getElementById('deliveryAddress').value;
                const city = document.getElementById('deliveryCity').value;
                
                document.getElementById('confirm-delivery-info').innerHTML = `
                    ${name}<br>
                    ${address}<br>
                    ${city}
                `;
            }
        }

        // Go to next checkout step
        function nextStep() {
            if (currentStep === 1) {
                // Validate delivery form
                const name = document.getElementById('deliveryName').value;
                const address = document.getElementById('deliveryAddress').value;
                const city = document.getElementById('deliveryCity').value;
                const postalCode = document.getElementById('deliveryPostalCode').value;
                const phone = document.getElementById('deliveryPhone').value;
                
                if (!name || !address || !city || !postalCode || !phone) {
                    alert('Please fill in all required delivery information');
                    return;
                }
            } else if (currentStep === 2) {
                // Validate payment form
                const cardName = document.getElementById('cardName').value;
                const cardNumber = document.getElementById('cardNumber').value;
                const cardExpiry = document.getElementById('cardExpiry').value;
                const cardCvv = document.getElementById('cardCvv').value;
                
                if (!cardName || !cardNumber || !cardExpiry || !cardCvv) {
                    alert('Please fill in all payment details');
                    return;
                }
            } else if (currentStep === 3) {
                // Complete order
                completeOrder();
                return;
            }

            currentStep++;
            updateCheckoutSteps();
        }

        // Go to previous checkout step
        function prevStep() {
            currentStep--;
            updateCheckoutSteps();
        }

        // Complete order
        function completeOrder() {
            // In a real app, you would process payment here
            // For demo, we'll just show success message

            checkoutModal.style.display = 'none';
            successModal.style.display = 'block';

            // Clear cart
            cart = [];
            updateCart();
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);

        // Handle hash changes for tabs
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash && hash !== currentTab) {
                switchTab(hash);
            }
        });
    </script>
</body>
</html>